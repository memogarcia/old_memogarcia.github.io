---
layout: post
title:  "Pratai, Event driven compute for OpenStack"
date:   2016-07-12 12:30:00
categories: zeromq python
---

### Abstract

Pratai provides an incredible flexibility on how to migrate workloads to the
cloud that respond to events without having to manage any server or network,
this allows your systems to be more flexible, loosely-coupled, scalable and
easier to develop while offering a more tolerant to failure environments.

Pratai offers an event driven platform that works with OpenStack to provide
server-less applications and services, No infrastructure management,
no VM spawning, no network provisioning, just run your code in OpenStack.


### How it works

The goal of Pratai is simple. Deploy "code" (disclaimer, from now on I
will refer to code as functions), that will react to an event without
worrying about anything else, the platform handles the execution. Simple right?

In order to achieve that, first, we need to deploy a function in a `zip` format for one of the
languages that the platform supports, the first one is python but more will be
added in the future, after this a docker image gets created with the custom
function and the requirements. e.g.

{% highlight python %}

# new_module.py

import numpy # yes you can install dependencies, just send a requirements.txt

def local_function(payload):
    # you can create local functions
    return payload

def main(payload=None):
    # a main function should always be declared
    # and using a payload as a parameter
    return local_function(payload)

{% endhighlight %}

When a function gets created it will remain as inactive, waiting to be executed
whenever an event happens that the function is subscribed to, could be a http
endpoint, which can be assigned at creation time, or a message in a queue but
basically every event will spawn a container that will execute the event and
then disappear.


### Architecture

#### Control Plane

An API gateway, an database cluster and a load balancer and a scheduler lives
in the control plane.

For the first version a API gateway built in python using flask will be made,
in the future I think Golang should be a better option for it.

An elasticsearch cluster will power the storage of events, function metadata
and cluster information.

And a nginx load balancer will connect 3 instances to the API in a `least_connect`
manner.

#### Pratai Nodes

A Pratai node is composed by a driver and runtimes.

When a new node is created it will automatically connect to the cluster and it
will start polling for events.

A driver is basically a container orchestrator like swarm, kubernetes, plain
docker, etc. in this case we will use docker.

The runtimes are the languages supported by the platform, they are a base
container image that contains an OS, a language and its dependencies, etc. that
can be used by the functions the users submits. e.g.

{% highlight bash %}

# seed/Dockerfile

FROM ubuntu:14.04

MAINTAINER Memo Garcia <sirmemogarcia@gmail.com>

RUN apt-get -y update

RUN apt-get install -y git unzip wget

{% endhighlight %}


{% highlight bash %}

# python27/Dockerfile

FROM pratai/seed:latest

MAINTAINER Memo Garcia <sirmemogarcia@gmail.com>

RUN apt-get install -y python python-dev python-setuptools python-pip
RUN pip install pip --upgrade

{% endhighlight %}

{% highlight bash %}

# python27_template.txt

FROM pratai/python27:latest
MAINTAINER Memo Garcia <sirmemogarcia@gmail.com>
RUN wget {zip_location}
RUN unzip {zip_file}
RUN pip install -r requirements.txt
RUN mkdir /etc/pratai/
RUN mkdir /var/log/pratai/
RUN cp new_module.py /etc/pratai/
RUN git clone "repo_with_runtimes"
CMD ["python", "/pratai-runtimes/runtimes/python27/server.py"]

{% endhighlight %}

#### Distributed Queues

ZeroMQ is the choice for queuing and passing messages in pratai using the PUSH/PULL
architecture we can create a pipelines of messages that can be distributed
across multiple nodes.

We will have a producer and a collector running in the scheduler, and consumers
running in the pratai nodes, one consumer should be spawned per thread.

![Reference architecture](/images/pushpull.png)

### Components

 * Agent
 * API gateway
 * Client
 * Drivers
 * Runtimes
 * Scheduler

### Community

Join us at `#pratai` irc channel in `freenode`

### References

[The Reactive Manifesto](http://www.reactivemanifesto.org)

[Cloud Design Patterns](https://msdn.microsoft.com/en-us/library/dn600223.aspx)
